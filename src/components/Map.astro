---
interface Props {
  lat?: number;
  lng?: number;
  zoom?: number;
  serviceRadius?: number;
  markerTitle?: string;
  markerAddress?: string;
}

const {
  lat = 46.1847,
  lng = -0.4833,
  zoom = 10,
  serviceRadius = 50000,
  markerTitle = 'EIRL REPAIN',
  markerAddress = '530 Route nationale, 79360 Beauvoir sur Niort'
} = Astro.props;
---

<div class="map-wrapper">
  <div
    id="map"
    class="map"
    data-lat={lat}
    data-lng={lng}
    data-zoom={zoom}
    data-radius={serviceRadius}
    data-title={markerTitle}
    data-address={markerAddress}
    aria-label="Carte de localisation EIRL REPAIN"
  >
    <!-- Fallback pendant le chargement -->
    <div class="map__loading">
      <div class="map__loading-spinner"></div>
      <p>Chargement de la carte...</p>
    </div>
  </div>

  <!-- Lien vers Google Maps -->
  <a
    href={`https://www.google.com/maps/place/${lat},${lng}/@${lat},${lng},14z`}
    target="_blank"
    rel="noopener noreferrer"
    class="map__fallback-link"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
      <circle cx="12" cy="10" r="3"/>
    </svg>
    Voir sur Google Maps
  </a>
</div>

<style>
  .map-wrapper {
    position: relative;
    border: 3px solid var(--color-yellow);
    border-radius: var(--radius-lg);
    overflow: hidden;
    background-color: var(--color-gray-light);
  }

  .map {
    width: 100%;
    height: 300px;
    position: relative;
    z-index: 1;
  }

  @media (min-width: 768px) {
    .map {
      height: 450px;
    }
  }

  .map__loading {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: var(--color-gray-light);
    color: var(--color-gray);
    gap: var(--spacing-md);
  }

  .map__loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-gray-light);
    border-top-color: var(--color-yellow);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .map__loading p {
    margin: 0;
    font-weight: 500;
  }

  .map__fallback-link {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm);
    background-color: var(--color-black);
    color: var(--color-yellow);
    font-size: 0.875rem;
    font-weight: 500;
    transition: background-color var(--transition-fast);
  }

  .map__fallback-link:hover {
    background-color: var(--color-gray-dark);
  }

  .map__fallback-link svg {
    flex-shrink: 0;
  }

  /* Styles globaux pour Leaflet - doivent être :global car injectés dynamiquement */
  :global(.leaflet-container) {
    font-family: var(--font-primary);
  }

  :global(.leaflet-popup-content-wrapper) {
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
  }

  :global(.leaflet-popup-content) {
    margin: 12px 16px;
    font-size: 0.9375rem;
    line-height: 1.5;
  }

  :global(.custom-popup) {
    text-align: center;
  }

  :global(.custom-popup strong) {
    display: block;
    font-size: 1rem;
    color: var(--color-black);
    margin-bottom: 4px;
  }

  :global(.custom-popup span) {
    color: var(--color-gray-dark);
    font-size: 0.875rem;
  }

  :global(.custom-popup a) {
    display: inline-block;
    margin-top: 8px;
    color: var(--color-yellow);
    background-color: var(--color-black);
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    font-size: 0.8125rem;
    font-weight: 600;
    text-decoration: none;
    transition: opacity 0.2s;
  }

  :global(.custom-popup a:hover) {
    opacity: 0.9;
  }
</style>

<script>
  // Chargement asynchrone de Leaflet pour ne pas bloquer le rendu initial
  async function initMap() {
    const mapContainer = document.getElementById('map');
    if (!mapContainer) return;

    // Récupérer les données depuis les attributs
    const lat = parseFloat(mapContainer.dataset.lat || '46.1847');
    const lng = parseFloat(mapContainer.dataset.lng || '-0.4833');
    const zoom = parseInt(mapContainer.dataset.zoom || '10', 10);
    const radius = parseInt(mapContainer.dataset.radius || '50000', 10);
    const title = mapContainer.dataset.title || 'EIRL REPAIN';
    const address = mapContainer.dataset.address || '';

    try {
      // Charger le CSS de Leaflet
      const linkEl = document.createElement('link');
      linkEl.rel = 'stylesheet';
      linkEl.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      linkEl.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
      linkEl.crossOrigin = '';
      document.head.appendChild(linkEl);

      // Charger le JS de Leaflet
      const L = await loadLeaflet();

      // Attendre que le CSS soit chargé
      await new Promise(resolve => setTimeout(resolve, 100));

      // Supprimer le loader
      const loader = mapContainer.querySelector('.map__loading');
      if (loader) loader.remove();

      // Initialiser la carte
      const map = L.map('map', {
        center: [lat, lng],
        zoom: zoom,
        scrollWheelZoom: false, // Désactivé par défaut pour éviter les scrolls accidentels
      });

      // Activer le scroll zoom au clic
      map.on('click', () => {
        map.scrollWheelZoom.enable();
      });

      // Désactiver quand la souris quitte la carte
      map.on('mouseout', () => {
        map.scrollWheelZoom.disable();
      });

      // Ajouter les tuiles OpenStreetMap avec un style sobre
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 18,
      }).addTo(map);

      // Créer une icône personnalisée noir/jaune
      const customIcon = L.divIcon({
        className: 'custom-marker',
        html: `
          <svg width="40" height="48" viewBox="0 0 40 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 0C8.954 0 0 8.954 0 20c0 14 20 28 20 28s20-14 20-28C40 8.954 31.046 0 20 0z" fill="#000000"/>
            <path d="M20 4C11.163 4 4 11.163 4 20c0 11 16 22 16 22s16-11 16-22c0-8.837-7.163-16-16-16z" fill="#FFE600"/>
            <circle cx="20" cy="18" r="6" fill="#000000"/>
          </svg>
        `,
        iconSize: [40, 48],
        iconAnchor: [20, 48],
        popupAnchor: [0, -48],
      });

      // Ajouter le marqueur personnalisé
      const marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);

      // Contenu du popup
      const popupContent = `
        <div class="custom-popup">
          <strong>${title}</strong>
          <span>${address}</span>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" rel="noopener">
            Itinéraire
          </a>
        </div>
      `;

      marker.bindPopup(popupContent);

      // Ajouter le cercle de zone de couverture (jaune transparent)
      L.circle([lat, lng], {
        radius: radius,
        color: '#FFE600',
        fillColor: '#FFE600',
        fillOpacity: 0.1,
        weight: 2,
        dashArray: '8, 8',
      }).addTo(map);

      // Injecter les styles du marqueur personnalisé
      const style = document.createElement('style');
      style.textContent = `
        .custom-marker {
          background: transparent;
          border: none;
        }
        .custom-marker svg {
          filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
      `;
      document.head.appendChild(style);

    } catch (error) {
      console.error('Erreur lors du chargement de la carte:', error);
      // Afficher un message d'erreur
      const loader = mapContainer.querySelector('.map__loading');
      if (loader) {
        loader.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#FFE600" stroke-width="1.5">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          <p>530 Route nationale, 79360 Beauvoir sur Niort</p>
        `;
      }
    }
  }

  // Fonction pour charger Leaflet dynamiquement
  function loadLeaflet(): Promise<typeof import('leaflet')> {
    return new Promise((resolve, reject) => {
      // Vérifier si déjà chargé
      if ((window as any).L) {
        resolve((window as any).L);
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
      script.crossOrigin = '';

      script.onload = () => resolve((window as any).L);
      script.onerror = reject;

      document.head.appendChild(script);
    });
  }

  // Utiliser Intersection Observer pour charger la carte uniquement quand visible
  const mapContainer = document.getElementById('map');

  if (mapContainer && 'IntersectionObserver' in window) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            initMap();
            observer.disconnect();
          }
        });
      },
      { rootMargin: '200px' } // Précharger un peu avant
    );

    observer.observe(mapContainer);
  } else {
    // Fallback pour les navigateurs sans IntersectionObserver
    initMap();
  }
</script>
